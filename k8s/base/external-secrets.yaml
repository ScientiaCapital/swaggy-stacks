apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secretsmanager
  namespace: swaggy-stacks
  labels:
    app.kubernetes.io/name: swaggy-stacks
    app.kubernetes.io/component: secrets
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        secretRef:
          accessKeyID:
            name: aws-secret
            key: access-key
          secretAccessKey:
            name: aws-secret
            key: secret-access-key
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: swaggy-stacks-external-secrets
  namespace: swaggy-stacks
  labels:
    app.kubernetes.io/name: swaggy-stacks
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 15m
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: swaggy-stacks-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      engineVersion: v2
      data:
        POSTGRES_PASSWORD: "{{ .postgres_password }}"
        DATABASE_URL: "postgresql://{{ .postgres_user }}:{{ .postgres_password }}@postgresql-service:5432/swaggy_stacks"
        SECRET_KEY: "{{ .jwt_secret_key }}"
        ALPACA_API_KEY: "{{ .alpaca_api_key }}"
        ALPACA_SECRET_KEY: "{{ .alpaca_secret_key }}"
        ANTHROPIC_API_KEY: "{{ .anthropic_api_key }}"
        PERPLEXITY_API_KEY: "{{ .perplexity_api_key }}"
        ALPHA_VANTAGE_API_KEY: "{{ .alpha_vantage_api_key }}"
        FINNHUB_API_KEY: "{{ .finnhub_api_key }}"
        SENTRY_DSN: "{{ .sentry_dsn }}"
  data:
  - secretKey: postgres_password
    remoteRef:
      key: swaggy-stacks/database
      property: password
  - secretKey: postgres_user
    remoteRef:
      key: swaggy-stacks/database
      property: username
  - secretKey: jwt_secret_key
    remoteRef:
      key: swaggy-stacks/auth
      property: jwt_secret
  - secretKey: alpaca_api_key
    remoteRef:
      key: swaggy-stacks/trading
      property: alpaca_api_key
  - secretKey: alpaca_secret_key
    remoteRef:
      key: swaggy-stacks/trading
      property: alpaca_secret_key
  - secretKey: anthropic_api_key
    remoteRef:
      key: swaggy-stacks/ai
      property: anthropic_api_key
  - secretKey: perplexity_api_key
    remoteRef:
      key: swaggy-stacks/ai
      property: perplexity_api_key
  - secretKey: alpha_vantage_api_key
    remoteRef:
      key: swaggy-stacks/market-data
      property: alpha_vantage_api_key
  - secretKey: finnhub_api_key
    remoteRef:
      key: swaggy-stacks/market-data
      property: finnhub_api_key
  - secretKey: sentry_dsn
    remoteRef:
      key: swaggy-stacks/monitoring
      property: sentry_dsn
---
apiVersion: v1
kind: Secret
metadata:
  name: aws-secret
  namespace: swaggy-stacks
  labels:
    app.kubernetes.io/name: swaggy-stacks
    app.kubernetes.io/component: secrets
type: Opaque
data:
  access-key: QVNTX0FDQ0VTU19LRVlfUExBQ0VIT0xERVI= # AWS_ACCESS_KEY_PLACEHOLDER
  secret-access-key: QVNTX1NFQ1JFVF9BQ0NFU1NfS0VZX1BMQUNFSE9MREVSQ= # AWS_SECRET_ACCESS_KEY_PLACEHOLDER